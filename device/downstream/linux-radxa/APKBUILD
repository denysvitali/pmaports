# Reference: <https://postmarketos.org/vendorkernel>
# Kernel config based on: arch/arm64/configs/rockchip_linux_defconfig
# Maintainer: Antoine Martin (ayakael) <dev@ayakael.net>
pkgname=linux-radxa
pkgver=6.1.84
pkgrel=0
pkgdesc="Radxa kernel fork"
arch="aarch64"
_carch="arm64"
_flavor="clockworkpi-uconsole-radxa-cm5"
url="https://kernel.org"
license="GPL-2.0-only"
options="!strip !check !tracedeps pmb:cross-native"
makedepends="
	bash
	bc
	bison
	devicepkg-dev
	dtc
	flex
	findutils
	installkernel
	linux-firmware
	linux-headers
	openssl-dev
	perl
	xz
"

# Source
_repository="kernel"
_commit="51ed5f015c3cbba79436c47db19896d6d7cd011f"
_dtso_commit="c2204834e1d7d0acfd64e1b7874d432bc142f1a4"
_config="config-$_flavor.$arch"
source="
	$pkgname-$_commit.tar.gz::https://github.com/radxa/$_repository/archive/$_commit.tar.gz
	radxa-cm5-uconsole-$_dtso_commit.tar.gz::https://github.com/dev-null2019/radxa-cm5-uconsole/archive/$_dtso_commit.tar.gz
	$_config
	0001-uconsole-video-backlight-Add-OCP8178-backlight-driver.patch
	0002-uconsole-drm-panel-add-clockwork-cwu50.patch
	0003-uconsole-power-axp20x_battery-implement-calibration.patch
	0004-uconsole-driver-staging-add-uconsole-simple-amplifier-switch.patch
"
builddir="$srcdir/$_repository-$_commit"
_dtsodir="$srcdir"/radxa-cm5-uconsole-$_dtso_commit/devicetree_overlays
_outdir="out"

prepare() {
	default_prepare
	cp "$srcdir/config-$_flavor.$CARCH" .config
}

build() {
	unset LDFLAGS
	make ARCH="$_carch" CC="${CC:-gcc}" \
		KBUILD_BUILD_VERSION="$((pkgrel + 1))-postmarketOS"

	# generate dtbo for uconsole
	for dts in "$_dtsodir"/*.dts; do
		cpp -nostdinc -I "$_dtsodir" -I arch -undef -x assembler-with-cpp $dts $dts.preprocessed
		dtc -O dtb -o ${dts/.dts/.dtbo} $dts.preprocessed
	done
}

package() {
	downstreamkernel_package "$builddir" "$pkgdir" "$_carch" "$_flavor"

	mkdir -p "$pkgdir"/boot
	make modules_install dtbs_install \
		ARCH="$_carch" \
		INSTALL_PATH="$pkgdir"/boot \
		INSTALL_MOD_PATH="$pkgdir" \
		INSTALL_MOD_STRIP=1 \
		INSTALL_DTBS_PATH="$pkgdir"/boot/dtbs
	rm -f "$pkgdir"/lib/modules/*/build "$pkgdir"/lib/modules/*/source

	# merge dtbos with soc dtb for uconsole
	fdtoverlay -i "$builddir"/arch/arm64/boot/dts/rockchip/rk3588s-radxa-cm5-rpi-cm4-io.dtb "$_dtsodir"/*.dtbo -o "$pkgdir"/boot/dtbs/rockchip/rk3588s-radxa-cm5-uconsole.dtb
}

sha512sums="
75269ce2ffbe3ca5a723203aefdda8b47c87730a5b34d828c71c8c7578d726e8f3fc0d526635033852c136e39c19af921a9965b6491ee5a7ae044c7c86d8b8de  linux-radxa-51ed5f015c3cbba79436c47db19896d6d7cd011f.tar.gz
a15eb74d9db9114022e96ba04542d18350cf6d637c5efa49f4a5a65c33c5fd20a7997095a049a561fb7aac767a299f367489c5a342138a5259cc32ebb6152384  radxa-cm5-uconsole-c2204834e1d7d0acfd64e1b7874d432bc142f1a4.tar.gz
a1c59ef7898f496b5478464f1d680f8d7b7316d16f6b7f26d72b2e6df3c45c3e3fd36093ec00aa649ca636b6c68a68a62861ac171e30e5d1d3f7c092e67f325a  config-clockworkpi-uconsole-radxa-cm5.aarch64
71b5d6a65e252da46105cd1b9984bdafdf970ddad0418aaa24b39e41d84eabbfd069e038f9c68f21fad37867b99a1bc2a2d326a4f1ae89e343d4c20f2cb2adbb  0001-uconsole-video-backlight-Add-OCP8178-backlight-driver.patch
a87746be6aa8731e4773824013fcfea9ec7aaac120653b1ddc5d9d7b883ca476ea51425335d82be4a015c4ffc979bc4d436cd801724bad38c5d5ccc604332474  0002-uconsole-drm-panel-add-clockwork-cwu50.patch
9f847d612911babc5dab77db540d8c7d3983e9a9650ac39f447c132dbc076bddcca0639c1f643e415d2651e36f95b15ca8a370759a1449b183128cc6356e51b3  0003-uconsole-power-axp20x_battery-implement-calibration.patch
52061711ce403ac288b60673430e205846aa8ec63759a01e0be3c5dc040b951c012963f3a9e4f6d8493456afff26b0860d944624153c64f27e3504c7c432136c  0004-uconsole-driver-staging-add-uconsole-simple-amplifier-switch.patch
"
